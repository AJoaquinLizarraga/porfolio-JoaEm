---
interface Props {
  link?: string | string[];
  description: string;
  company: string;
  projectName?: string;
  date: string;
  title: string;
  more?: string | string[];
}
const { link, company, description, title, date, more } = Astro.props;
import LinkButton from "../components/LinkButton.astro";

const paragraphs = description.split("\n");

const formattedParagraphs = paragraphs.map((para) =>
  para
    .replace(/(Pursuit:)/g, "<strong>$1</strong>")
    .replace(/(Rentscape:)/g, "<strong>$1</strong>")
    .replace(/(Spark n Co:)/g, "<strong>$1</strong>")
    .replace(/(Onde:)/g, "<strong>$1</strong>")
    .replace(/(SugarSync:)/g, "<strong>$1</strong>")
);

// Check if description is long (has multiple sections/headers)
const isLongDescription = description.includes("<h1") || description.length > 500;
---

<!-- Timeline dot with pulse animation -->
<div
  class="absolute w-3.5 h-3.5 rounded-full -start-[7px] border-2 border-gray-900 bg-gradient-to-br from-sky-400 to-blue-600 shadow-lg shadow-sky-500/30">
</div>

<!-- Card container -->
<div class="group relative ml-2 p-5 rounded-xl bg-white/[0.03] border border-white/10 hover:border-sky-500/30 hover:bg-white/[0.06] transition-all duration-300 ease-out hover:shadow-lg hover:shadow-sky-500/5">

  <!-- Date badge -->
  <div class="inline-flex items-center gap-2 mb-3">
    <span class="px-3 py-1 text-xs font-medium rounded-full bg-sky-500/10 text-sky-300 border border-sky-500/20">
      {date}
    </span>
  </div>

  <!-- Title and company -->
  <h3 class="text-lg md:text-xl font-semibold text-gray-100 leading-tight mb-1">
    {title}
  </h3>
  <a
    href={Array.isArray(link) ? link[0] : link}
    target="_blank"
    class="inline-flex items-center gap-1.5 text-yellow-400/90 hover:text-yellow-300 transition-colors font-medium text-sm group/link"
  >
    <span>@{company}</span>
    <svg class="w-3.5 h-3.5 opacity-0 -translate-x-1 group-hover/link:opacity-100 group-hover/link:translate-x-0 transition-all" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
    </svg>
  </a>

  <!-- Description with optional collapse -->
  {isLongDescription ? (
    <div class="mt-4">
      <div
        class="experience-content collapsed overflow-hidden transition-all duration-500 ease-in-out"
        data-expanded="false"
      >
        <div class="prose-content text-gray-300/90 text-sm md:text-base leading-relaxed space-y-3
          [&>p]:mb-3
          [&>p>strong]:text-emerald-400 [&>p>strong]:font-semibold
          [&>p>b]:text-yellow-400 [&>p>b]:font-semibold
          [&_h1]:text-2xl [&_h1]:font-bold [&_h1]:text-white/90 [&_h1]:mt-5 [&_h1]:mb-2 [&_h1]:pb-1 [&_h1]:pt-8 [&_h1]:border-t   [&_h1]:border-white/50"
        >
          {formattedParagraphs.map((para) => (
            <p set:html={para.trim()} />
          ))}
        </div>
      </div>

      <!-- Expand/Collapse button -->
      <button
        class="expand-btn mt-3 flex items-center gap-2 text-sm text-sky-400 hover:text-sky-300 transition-colors cursor-pointer group/expand"
        type="button"
      >
        <span class="expand-text">Show more</span>
        <svg class="expand-icon w-4 h-4 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
    </div>
  ) : (
    <div class="mt-4 text-gray-300/90 text-sm md:text-base leading-relaxed space-y-3
      [&>p]:mb-3
      [&>p>strong]:text-emerald-400 [&>p>strong]:font-semibold
      [&>p>b]:text-indigo-400 [&>p>b]:font-semibold">
      {formattedParagraphs.map((para) => (
        <p set:html={para.trim()} />
      ))}
    </div>
  )}

  <!-- Links section -->
  {(Array.isArray(link) || link) && (
    <div class="flex flex-wrap gap-2 mt-5 pt-4 border-t border-white/5">
      {Array.isArray(link) ? (
        link.map((url, index) => (
          <LinkButton link={url}>
            {Array.isArray(more) && more[index]}
            <svg
              class="w-3 h-3 ms-1.5 transition-transform group-hover:translate-x-0.5"
              aria-hidden="true"
              fill="none"
              viewBox="0 0 14 10">
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M1 5h12m0 0L9 1m4 4L9 9"
              />
            </svg>
          </LinkButton>
        ))
      ) : link ? (
        <LinkButton link={link}>
          {more === "" ? `Learn more...` : more}
          <svg
            class="w-3 h-3 ms-1.5 transition-transform group-hover:translate-x-0.5"
            aria-hidden="true"
            fill="none"
            viewBox="0 0 14 10">
            <path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M1 5h12m0 0L9 1m4 4L9 9"
            />
          </svg>
        </LinkButton>
      ) : null}
    </div>
  )}
</div>

<style>
  .experience-content.collapsed {
    max-height: 120px;
    mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
  }

  .experience-content.expanded {
    max-height: none;
    mask-image: none;
    -webkit-mask-image: none;
  }

  .expand-btn .expand-icon.rotated {
    transform: rotate(180deg);
  }
</style>

<script>
  document.querySelectorAll('.expand-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const content = btn.parentElement?.querySelector('.experience-content');
      const icon = btn.querySelector('.expand-icon');
      const text = btn.querySelector('.expand-text');
      const card = btn.closest('.group');

      if (content && icon && text) {
        const isExpanded = content.getAttribute('data-expanded') === 'true';

        if (isExpanded) {
          content.classList.remove('expanded');
          content.classList.add('collapsed');
          content.setAttribute('data-expanded', 'false');
          icon.classList.remove('rotated');
          text.textContent = 'Show more';

          // Scroll back to the top of the card
          if (card) {
            setTimeout(() => {
              card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
          }
        } else {
          content.classList.remove('collapsed');
          content.classList.add('expanded');
          content.setAttribute('data-expanded', 'true');
          icon.classList.add('rotated');
          text.textContent = 'Show less';
        }
      }
    });
  });
</script>
